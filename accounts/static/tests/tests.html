<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Javascript tests</title>
    <link rel="stylesheet" href="../../../superlists/static/tests/qunit.css">
</head>

<body>
    <div id="qunit"></div>
    <div id="qunit-fixture">
        <a id="id_login">Sign in</a>
    </div>

    <script src="../../../superlists/static/jquery.js"></script>
    <script src="../../../superlists/static/tests/qunit.js"></script>
    <script src="../../../superlists/static/tests/sinon.js"></script>
    <script src="../accounts.js"></script>
    <script>

test("initialize binds sign in button to navigator.id.request", function () {
    var requestWasCalled = false;
    var mockRequestFunction = function() { requestWasCalled = true; };
    var mockNavigator = {
        id: {
            request: mockRequestFunction,
            watch: function () {}
        }
    };

    Superlists.Accounts.initialize(mockNavigator);
    equal(requestWasCalled, false, 'check request not called before click'); 

    $('#id_login').trigger('click');
    equal(requestWasCalled, true, 'check request called after click'); 
});


var user1 = 'current user';
var token1 = 'csrf token';
var urls1 = { login: 'login url', logout: 'logout url'};
var mockNavigator1 = sinon.spy();
var assertion1 = 'i assert this';
mockNavigator1.id = sinon.spy();
mockNavigator1.id.watch = sinon.spy();

module('sinon navigator tests', {
    setup: function () {
        requests = [];
        xhr = sinon.useFakeXMLHttpRequest();
        xhr.onCreate = function (request) { requests.push(request); };
        Superlists.Accounts.initialize(mockNavigator1, user1, token1, urls1);
    },
    teardown: function () {
        mockNavigator1.reset()
        mockNavigator1.id.reset()
        mockNavigator1.id.watch.reset()
        xhr.restore() 
    }
});

test("initialize calls navigator.id.watch with sinon", function () {
    equal(mockNavigator1.id.watch.calledOnce, true, 'check watch function called');
});

test("navigator.id.watch called with correct user", function () {
    var call = mockNavigator1.id.watch.firstCall.args[0]
    equal(call.loggedInUser, user1, 'check user');
});

test("onlogin will do a POST to the right URL", function () {
    var call = mockNavigator1.id.watch.firstCall.args[0]
    call.onlogin(assertion1);

    equal(requests.length, 1, 'check request made');
    var request = requests[0];
    equal(request.method, 'POST', 'check request was a POST');
    equal(request.url, urls1.login, 'check url');
    equal(
        request.requestBody,
        $.param({ assertion: assertion1, csrfmiddlewaretoken: token1 }),
        'check POST data'
    );
});

test("onlogin does window reload on success", function () {
    var server = sinon.fakeServer.create();
    server.respondWith('OK');
    console.log('rp test?');
    sinon.spy(Superlists.Accounts, 'refreshPage');

    var call = mockNavigator1.id.watch.firstCall.args[0]
    call.onlogin(assertion1);

    server.respond()

    equal(
        Superlists.Accounts.refreshPage.called, true,
        'should call refreshPage'
    );
    console.log('yup..');
});


    </script>
</body>
</html>
